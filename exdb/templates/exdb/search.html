{% extends "exdb/base.html" %}
{% load i18n %}
{% load exdbtags %}
{% load staticfiles %}
{% block css %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static 'exdb/css/search.css' %}" />
{% endblock %}
{% block javascript %}
    {{ block.super }}
    <script type="text/javascript" src="{% static 'exdb/js/search.js' %}"></script>
{% endblock %}
{% block content %}
    {{ block.super }}

    <div class="row">
        <button id="export" class="button" data-url="{% url 'search_report' %}">{% trans "Export as CSV" %}</button>
        <div id="no-experience-warning" class="hide">{% trans "No experiences to export!" %}</div>
        {% if experiences %}
            <table id="search-results" class="tablesorter responsive">
                <thead>
                    <tr>
                        <th data-placeholder="&#xf002;">{% trans "Experience Name" %}</th>
                        <th data-placeholder="&#xf002;">{% trans "Planners" %}</th>
                        <th data-placeholder="&#xf002;">{% trans "Type" %}</th>
                        <th data-placeholder="&#xf002;">{% trans "Subtypes" %}</th>
                        <th data-placeholder="&#xf002;">{% trans "Building" %}</th>
                        <th data-placeholder="&#xf002;">{% trans "Keywords" %}</th>
                        <th data-placeholder="&#xf002;">{% trans "Status" %}</th>
                        <th data-placeholder="&#xf002;" data-sorter="shortDate">{% trans "Start Time" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for exp in experiences %}
                        <tr class="link" data-url="{% experience_url exp user %}" data-pk="{{ exp.pk }}">
                            <td class="exp-name">{{ exp.name }}</td>
                            <td class="planners">
                                {% for planner in exp.planners.all %}
                                    {{ planner }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </td>
                            <td class="type">{{ exp.type }}</td>
                            <td class="subtype">
                                {% for subtype in exp.subtypes.all %}
                                    {{ subtype }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </td>
                            <td class="recognition">
                                {% for rec in exp.recognition.all %}
                                    {{ rec.affiliation }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </td>
                            <td class="keywords">
                                {% for keyword in exp.keywords.all %}
                                    {{ keyword }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </td>
                            <td class="status">{{ exp.get_status_display }}</td>
                            <td class="start-time">{{ exp.start_datetime|date:'N j, Y g:i A' }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- PAGINATION CONTROLS -->
            <div class="pagination-controls">
                <!-- Page size selector -->
                <form method="get">
                    {% for key, value in request.GET.items %}
                        {% if key != 'page_size' and key != 'page' %}
                            <input type="hidden" name="{{ key }}" value="{{ value }}">
                        {% endif %}
                    {% endfor %}
                    <label for="page_size">{% trans "Results per page:" %}</label>
                    <select name="page_size" onchange="this.form.submit()">
                        {% for size in page_sizes %}
                            {% if request.GET.page_size %}
                                {% if size|stringformat:"s" == request.GET.page_size %}
                                    <option value="{{ size }}" selected>{{ size }}</option>
                                {% else %}
                                    <option value="{{ size }}">{{ size }}</option>
                                {% endif %}
                            {% else %}
                                {% if size == 5 %}
                                    <option value="{{ size }}" selected>{{ size }}</option>
                                {% else %}
                                    <option value="{{ size }}">{{ size }}</option>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </select>
                </form>

                <!-- Previous / Next buttons -->
                {% if is_paginated %}
                    <div class="pagination-links">
                        {% with request.GET.urlencode|cut:"page=" as querystring %}
                            {% if page_obj.has_previous %}
                                <a href="?search={{ search_query }}&page={{ page_obj.previous_page_number }}&page_size={{ request.GET.page_size|default:"5" }}">Previous</a>
                            {% endif %}

                            <span class="current-page">{% trans "Page" %} {{ page_obj.number }} {% trans "of" %} {{ paginator.num_pages }}</span>

                            {% if page_obj.has_next %}
                                <a href="?search={{ search_query }}&page={{ page_obj.next_page_number }}&page_size={{ request.GET.page_size|default:"5" }}">Next</a>
                            {% endif %}
                        {% endwith %}
                    </div>
                {% endif %}
            </div>

        {% else %}
            <p>{% trans "Your search returned no experiences" %}</p>
        {% endif %}
    </div>

{% endblock %}
